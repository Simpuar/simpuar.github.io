---
layout: post
title: HSE — Operating Systems Security — Lab 2
date: 2022-10-27 00:00:00 -500
categories: [Higher School of Economics]
tags: [Linux, Operating Systems Security]
---

<img src="/assets/images/HSE/OSS/Lab%202/logo.png" width="30%">

---

<center><strong><font color="White">Создание пользователей. Права пользователей. ACL.</font></strong></center>

---

## <strong><font color="#34A5DA">1. Создание пользователей. Задание паролей. Сброс пароля пользователя</font></strong>

1. Создать две учетные записи пользователей: `vlad`, `alex`.

<img src="/assets/images/HSE/OSS/Lab%202/1.png" width="80%">
*Создание пользователя `vlad`*

<img src="/assets/images/HSE/OSS/Lab%202/2.png" width="80%">
*Создание пользователя `alex`*

Пароли: `1234` и `2345` соответственно

---

{:start="2"}
2. Задать пользователям одинаковые пароли

<img src="/assets/images/HSE/OSS/Lab%202/3.png" width="80%">

Заданный пароль: `12`

---

{:start="3"}
3. Проанализировать файл `/etc/shadow` и `/etc/passwd`. Сделать соответствующие выводы.

<img src="/assets/images/HSE/OSS/Lab%202/4.png" width="80%">
*Файл `/etc/passwd`*

<img src="/assets/images/HSE/OSS/Lab%202/5.png" width="80%">
*Файл `/etc/shadow`*

Пароль пользователя `parallels` был скрыт.

Видим, что пользователям `vlad` и `alex` были заданы UID `1001` и `1002` и GID `1001` и `1002` соответственно. Видим, что UID совпадает с GID.

Также несмотря на то, что мы задали одинаковые пароли, хэш паролей различается из-за соли.

---

{:start="4"}
4. Из файла `/etc/shadow` удалить свертку пароля пользователя `vlad`.

Использованная команда для редактирования файла: `nano`.

<img src="/assets/images/HSE/OSS/Lab%202/6.png" width="80%">

---

{:start="5"}
5. Проверить, каким образом `vlad` войдет в систему. Сделать выводы.

Вход был выполнен без пароля.

<img src="/assets/images/HSE/OSS/Lab%202/7.png" width="80%">

---

{:start="6"}
6. В файле `/etc/shadow` заменить свертку пароля для пользователя `vlad` сверткой пароля `alex`.

Использованная команда для редактирования файла: `nano`.

<img src="/assets/images/HSE/OSS/Lab%202/8.png" width="80%">

---

{:start="7"}
7. Проверить, каким образом `vlad` войдет в систему. Сделать выводы.

<img src="/assets/images/HSE/OSS/Lab%202/9.png" width="80%">

Для входа потребовался пароль. Пароль `12` подошел. То есть, мы видим, что замена хэша пароля меняет пароль.

## <strong><font color="#34A5DA">2. Создание пользователей вручную</font></strong>

1. Вручную (без использования команды `useradd` или `adduser`) добавить пользователя `dasha`.

Воспользуемся командой `vipw` с выбором редактора `nano`, чтобы другие команды не пробовали модифицировать его в это же время.

<img src="/assets/images/HSE/OSS/Lab%202/10.png" width="80%">
*Добавленный пользователь `dasha` в файле `/etc/passwd`*

<img src="/assets/images/HSE/OSS/Lab%202/11.png" width="80%">
*Создание домашней директории для пользователя `dasha`*

<img src="/assets/images/HSE/OSS/Lab%202/12.png" width="80%">
*Проверка домашней директории для пользователя `dasha`*

---

{:start="2"}
1. Пароль пользователя задать вручную (без использования команды `passwd`).

С помощью редактора `nano` добавим новую строчку, содержащую данные о пользователе `dasha`. Хэш пароля возьмем от двух других пользователей.

<img src="/assets/images/HSE/OSS/Lab%202/13.png" width="80%">
*Добавленный пользователь `dasha` в файле `/etc/shadow`*

---

{:start="3"}
3. Задать ограничения на пароль вручную, время действия пароля 3 дня (без использования команды *`passwd`*).
    
<img src="/assets/images/HSE/OSS/Lab%202/BSYSecurityClassDiagrams-_etc_shadow(L).jpg" width="80%"> 

<img src="/assets/images/HSE/OSS/Lab%202/14.png" width="80%">
*Добавление времени действия пароля для пользователя `dasha`*

---

{:start="4"}
1. Задать ограничения на пароль вручную, предупреждать о смене пароля за 5 дней (без использования команды *`passwd`*), убедиться в наличии предупреждений.

<img src="/assets/images/HSE/OSS/Lab%202/15.png" width="80%">
*Добавление количества дней перед уведомлением об истечении срока пароля для пользователя `dasha`*

<img src="/assets/images/HSE/OSS/Lab%202/16.png" width="80%">
*Проверка предупреждения*

## <strong><font color="#34A5DA">3. Добавление пользователей в привилегированную группу (sudoers)</font></strong>

1. Добавить пользователю `dasha` возможность выполнять команды от имени пользователя `vlad` с запросом пароля.

```bash
sudo visudo
```

<img src="/assets/images/HSE/OSS/Lab%202/17.png" width="80%">
*Добавление пользователю `dasha` возможности выполнения команд от имени `vlad`*

---

{:start="2"}
2. Убедиться в возможности выполнения команд от имени пользователя `vlad`

<img src="/assets/images/HSE/OSS/Lab%202/18.png" width="80%">
*Выполнение команды `whoami` от имени пользователя `vlad` для `dasha`*

---

{:start="3"}
1. Добавить пользователю `anna` возможность выполнять команды от имени пользователя `alex` без запроса пароля.

> Для выполнения задания был создан пользователь `anna`

<img src="/assets/images/HSE/OSS/Lab%202/19.png" width="80%">
*Добавление пользователю `anna` возможности выполнения команд от имени `alex`*

<img src="/assets/images/HSE/OSS/Lab%202/20.png" width="80%">
*Выполнение команды `whoami` от имени пользователя `alex` для `anna`*

## <strong><font color="#34A5DA">4. Разграничение прав пользователей</font></strong>

1. Создать двух пользователей `donald` и `richard`.

<img src="/assets/images/HSE/OSS/Lab%202/21.png" width="80%">
*Создание пользователя `donald`*

<img src="/assets/images/HSE/OSS/Lab%202/22.png" width="80%">
*Создание пользователя `richard`*

---

{:start="2"}
2. В директории `/tmp` создать файл `magic`.

<img src="/assets/images/HSE/OSS/Lab%202/23.png" width="80%">
*Создание файла magic в директории `/tmp`*

---

{:start="3"}
3. Настроить его ACL таким образом, чтобы `donald` имел полный доступ к файлу, а `richard` мог только читать из него.

<img src="/assets/images/HSE/OSS/Lab%202/24.png" width="80%">
*Настройка ACL для пользователей `donald` и `richard`*

```bash
sudo sysctl fs.protected_regular=0s
```

---

{:start="4"}
4. Убедиться, что права настроены правильно, для этого записать от имени `donald` данные файл, а затем считать их от имени `richard`. Затем попробовать записать от имени `richard` и убедиться, что это сделать невозможно.

<img src="/assets/images/HSE/OSS/Lab%202/25.png" width="80%">
*Запись в файл `magic` от имени `donald`*

<img src="/assets/images/HSE/OSS/Lab%202/26.png" width="80%">
*Чтение файла `magic` от имени `richard`. Попытка записи в файл magic от имени `richard`*

## <strong><font color="#34A5DA">5. Рекурсивная настройка прав директорий</font></strong>

1. В директории `/tmp` создать следующую структуру файлов:
    
<img src="/assets/images/HSE/OSS/Lab%202/27.png" width="10%">
    
<img src="/assets/images/HSE/OSS/Lab%202/28.png" width="80%">
*Создание структуры файлов в директории `/tmp`*

---

{:start="2"}
2. Рекурсивно установить ACL права на всю указанную выше структуру так, чтобы `donald` мог писать в каждую поддиректорию.

<img src="/assets/images/HSE/OSS/Lab%202/29.png" width="80%">
*Установка ACL прав на всю структуру для пользователя `donald`*

---

{:start="3"}
3. Убедиться в правильности установки прав, создав следующую структуру от имени `donald`:
    
<img src="/assets/images/HSE/OSS/Lab%202/30.png" width="10%">
    

<img src="/assets/images/HSE/OSS/Lab%202/31.png" width="80%">
*Создание файлов пользователе `donald`*

<img src="/assets/images/HSE/OSS/Lab%202/32.png" width="80%">
*Созданные файлы*

## <strong><font color="#34A5DA">6. ACL по умолчанию</font></strong>

1. В директории *`/*tmp` создать поддиректорию `incredible`*.*

<img src="/assets/images/HSE/OSS/Lab%202/33.png" width="80%">
*Создание директории `incredible`*

{:start="2"}
2. Установить на эту директорию ACL по умолчанию таким образом, чтобы `donald` мог только читать файлы, размещённые в нём, а `richard` мог только записывать в файлы в нём.

<img src="/assets/images/HSE/OSS/Lab%202/34.png" width="80%">
*Установка ACL на директорию `incredible` для пользователей `donald` и `richard`*

---

{:start="3"}
3. Убедиться, что права настроены правильно, для этого создать файл `method` в этой директории и попробовать записать в него данные сначала от имени `donald`, убедиться, что это невозможно, а затем от имени `richard`. Аналогично, попробовать считать данные по очереди за каждого из созданных пользователей.

<img src="/assets/images/HSE/OSS/Lab%202/35.png" width="80%">
*Создание файла `method`*

<img src="/assets/images/HSE/OSS/Lab%202/36.png" width="80%">
*Попытка записи в файл `method` пользователем `donald`*

<img src="/assets/images/HSE/OSS/Lab%202/37.png" width="80%">
*Запись в файл `method` и попытка чтения `method` пользователем `richard`*

<img src="/assets/images/HSE/OSS/Lab%202/38.png" width="80%">
*Чтение файла `method` пользователем `donald`*

---

{:start="4"}
1. Создать ещё один файл `cheese` в `tmp`. Установить его права в ACL так, чтобы `richard` мог из него читать. Убедиться, что `richard` имеет возможность читать из `cheese`. Для этого от имени `richard` записать в него данные, а затем вывести его содержимое на экран.

<img src="/assets/images/HSE/OSS/Lab%202/39.png" width="80%">
*Создание в директории `tmp` файла `cheese`*

<img src="/assets/images/HSE/OSS/Lab%202/40.png" width="80%">
*Установка прав для пользователя `richard` для файла `cheese`*

<img src="/assets/images/HSE/OSS/Lab%202/41.png" width="80%">
*Запись и чтение пользователем `richard` файла `cheese`*

## <strong><font color="#34A5DA">7. Эффективная маска</font></strong>

1. Создать в директории *`/tmp`* файл `history` и записать в него произвольный текст.

<img src="/assets/images/HSE/OSS/Lab%202/42.png" width="80%">
*Создание файла `history` в директории `tmp`*

---

{:start="2"}
1. Модифицировать ACL: дать пользователю `donald` право на чтение и запись в `history`.

<img src="/assets/images/HSE/OSS/Lab%202/43.png" width="80%">
*Установка прав ACL пользователю `donald` для файла `history`*

---

{:start="3"}
3. Установить в ACL этого файла эффективную маску так, чтобы никто не мог записывать в файл.

<img src="/assets/images/HSE/OSS/Lab%202/44.png" width="80%">
*Установка эффективной маски для файла `history`*

---

{:start="4"}
1. Убедиться в том, что `donald` не может ничего записать в `history`, но может из него считать.

<img src="/assets/images/HSE/OSS/Lab%202/45.png" width="80%">
*Попытка записи и чтение файла `history` пользователем `donald`*

## <strong><font color="#34A5DA">8. Копирование ACL</font></strong>

1. Создать в директории `/tmp` файлы `notebook` и `illusion` и записать в них текстовую информацию. Установить этим файлам стандартные UNIX-права `660`, чтобы `donald` и `richard` не имели доступа к файлам.

<img src="/assets/images/HSE/OSS/Lab%202/46.png" width="80%">
*Создание файлов `notebook` и `illusion` и запись в них текста*

<img src="/assets/images/HSE/OSS/Lab%202/47.png" width="80%">
*Установка стандартных UNIX–прав для файлов `notebook` и `illusion`*

---

{:start="2"}
1. Настроить ACL правила `notebook` так, чтобы `donald` мог читать из него, а правила `illusion` так, чтобы из него мог читать `richard`.

<img src="/assets/images/HSE/OSS/Lab%202/48.png" width="80%">
*Установка прав ACL для файлов `notebook` и `illusion`*

---

{:start="3"}
3. Убедиться, что каждый из пользователей может читать из соответствующего файла.

<img src="/assets/images/HSE/OSS/Lab%202/49.png" width="80%">
*Чтение файла `notebook` пользователем `donald`*

<img src="/assets/images/HSE/OSS/Lab%202/50.png" width="80%">
*Чтение файла `illusion` пользователем `richard`*

---

{:start="4"}
4. Скопировать ACL из файла `notebook` в файл `illusion`.

<img src="/assets/images/HSE/OSS/Lab%202/51.png" width="80%">
*Копирование ACL из `notebook` в `illusion`*

---

{:start="5"}
5. Убедиться, что из файла `illusion` может читать только пользователь `donald`.

<img src="/assets/images/HSE/OSS/Lab%202/52.png" width="80%">
*Попытка чтения файла `illusion` пользователем `richard`*

<img src="/assets/images/HSE/OSS/Lab%202/53.png" width="80%">
*Чтение файла `illusion` пользователем `donald`*

## <strong><font color="#34A5DA">Выводы</font></strong>

В данной лабораторной работе были отработаны навыки создания пользователей при помощи команд и вручную. Также настройка sudoers для исполнения команд от имени других пользователей. Также были отработаны всевозможные варианты настройки ACL прав.

## <strong><font color="#34A5DA">Контрольные вопросы</font></strong>

### <font color="#FFA500">1. Перечислите основные команды для работы с пользователями и группами</font>

- `useradd` & `adduser`
- `userdel` & `deluser`
- `groupadd` & `addgroup`
- `newusers`
- `users`
- `passwd`
- `su`
- `sudo`


### <font color="#FFA500">2. Почему нужны два разных файла `/etc/passwd` и `/etc/shadow`, почему нельзя использовать один из них?</font>

В файле `/etc/passwd` хранится общая информация о пользователях.

В файле `/etc/shadow` хранится информация о паролях пользователей.

Некоторые командам нужна информация о пользователях, например для нахождения UID по именам пользователей или наоборот. Поэтому файл `/etc/passwd` общедоступен и каждый его может прочитать. А критически важная информация уже хранится в `/etc/shadow` и доступ к ней имеет только root.

### <font color="#FFA500">3. Зачем нужны SUID и SGID и Stickybit?</font>

**SUID**

Пусть пользователь хочет сменить пароль, тогда ему для этого нужны права для записи в файл `/etc/shadow`. Однако, файл `/etc/shadow` доступен только root. Так, пользователь не смог бы сменить пароль. Но благодаря SUID–биту установленному для команды `passwd`, эта команда запускается от имени root, что позволяет пользователю сменить пароль. Так, при использовании команды `passwd` с этим битом, пользователь временно получает права root.

---

**SGID**

SGID аналогичен SUID — файл будет запущен от имени группы владельца файла.

Обычно его используют для директорий, чтобы автоматически устанавливать группу владельца для поддиректорий такой же как у главной директории.

---

**Sticky bit**

Например, мы создали общую папку для пользователей. Пользователь имеет право туда писать. Однако, так, он также может удалить абсолютно всё из этой папки. Но, установив sticky бит на эту директорию, пользователь в этой директории сможет удалить только те файлы, владельцем которых он является.

### <font color="#FFA500">4. Зачем в Linux были введены списки контроля доступа?</font>

Потому что с обычными правами невозможно задать права для нескольких пользователей или групп сразу.

### <font color="#FFA500">5. Какие базовые утилиты используются для управления ACL?</font>

- `getfacl`
- `setfacl`

### <font color="#FFA500">6. Зачем нужны ACL по умолчанию?</font>

Для того, чтобы эти ACL автоматически устанавливались для новых созданных файлов или директорий.

### <font color="#FFA500">7. Как понять, что для файла установлен ACL?</font>

При вызове команды `ls -l` в конце прав будет символ `+`.

### <font color="#FFA500">8. Чем лучше воспользоваться, когда необходимо разрешить
выполнение конкретного исполняемого файла конкретному пользователю, ACL или прописать правило в sudoers?</font>

В случае, если выполнение нужно было бы от имени root, я бы воспользовался ACL, так как, удалив файл, удалятся и привилегии. А, если мы удалили этот исполняемый файл, но sudoers не изменили, то можно создать файл и запустить его. С точки зрения пентеста.

В ином случае, лучше воспользоваться sudoers.